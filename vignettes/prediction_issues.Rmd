---
title: "Issues in predicting from CBS models in JAMES"
author: "Stef van Buuren, Mirthe Hendriks"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Issues in predicting from CBS models in JAMES}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>")
```

```{r setup}
library(bdsmodels)
```

## Background

One of the steps in the C4PO project is to export models fitted is the closed CBS environment to the external application environment JAMES. Here we document the steps takes for a random forest model.

## Model estimates

We have available model `20230525_rfr_mtry` which predicts child overweight (YES/NO) at 4 years from predictors collected up to the child age of 4 months. The model contains 138 predictors, and can be exported from the closed CBS environment as a `ranger` model object with

```{r}
# read model
library(ranger)
library(tibble)
path <- path.expand("~/Package/c4po/c4po")
fn <- file.path(path, "data-raw/data", "20230525_rfr_mtry.rds")
mod <- readRDS(fn)
mod
```

## Child data

The child data arrive as JSON files, which needs to be augmented to fit the 138 variables in the model.

```{r}
fn <- system.file("extdata/bds_v3.0/smocc/Laura_S.json", package = "jamesdemodata")
fn <- system.file("extdata/bds_v3.0/smocc/Tim_S.json", package = "jamesdemodata")
fn <- system.file("extdata/bds_v3.0/graham/Hasna_G.json", package = "jamesdemodata")  # zwaar
fn <- system.file("extdata/bds_v3.0/graham/Sven_G.json", package = "jamesdemodata")
fn <- system.file("extdata/bds_v3.0/graham/Nikki_G.json", package = "jamesdemodata")  # licht
# fn <- system.file("extdata/bds_v3.0/graham/Nienke_G.json", package = "jamesdemodata")  # geen data

m <- bdsreader::read_bds(fn)
x <- collect_predictors(m, purpose = "model")
ex <- map_varnames(x)
dim(ex)
print(ex, width = Inf)
```

## Prediction

Feeding the augmented data `ex` into the model does not work:

```{r}
try(predict(mod, data = ex))
```

## Work around 1

Let's do a very crude repair by imputing zeroes everywhere.

```{r eval = FALSE}
fd <- ex
fd$name <- ""
fd[sapply(fd, is.factor)] <- 1
fd[is.na(fd)] <- 0
p <- predict(mod, data = fd)
p$predictions
```
The estimated overweight probability varies roughly between 0.16 (Nikki_G, an extremely light child) and 0.48 (Hasna_G, a very heavy child). The estimate for Nikki_G seems not well-calibrated (far too high).

## Data

```{r}
fn <- system.file("extdata/bds_v3.0/graham/Hasna_G.json", package = "jamesdemodata")
m <- bdsreader::read_bds(fn)
x <- collect_predictors(m, purpose = "model")
print(x, width = Inf)
```

```{r}
fn <- system.file("extdata/bds_v3.0/graham/Nikki_G.json", package = "jamesdemodata")
m <- bdsreader::read_bds(fn)
x <- collect_predictors(m, purpose = "model")
print(x, width = Inf)
```
